#!/bin/bash
set -e

# Fast pre-push validation optimized for <5 second target
# Catches the most common failure modes quickly (80/20 rule)

echo "Running fast pre-push validation..."
START=$(date +%s)

# Quick bypass for emergency pushes
if [ "${SKIP_PREPUSH:-0}" = "1" ]; then
    echo "Pre-push checks bypassed with SKIP_PREPUSH=1"
    exit 0
fi

# Phase 1: Essential compilation check (catches 80% of issues)
echo "• Testing build..."
if ! ./zig/zig build >/dev/null 2>&1; then
    echo "✗ Build failed - fix compilation errors before pushing"
    echo "Run: ./zig/zig build"
    exit 1
fi

# Phase 2: Fast unit tests (catches most logic errors) 
echo "• Running unit tests..."
if ! ./zig/zig build test >/dev/null 2>&1; then
    echo "✗ Unit tests failed - fix test failures before pushing"
    echo "Run: ./zig/zig build test"
    exit 1
fi

END=$(date +%s)
DURATION=$((END - START))
echo "✓ Fast pre-push validation passed (${DURATION}s)"
echo ""
echo "Note: Full validation runs in CI (cross-platform, integration tests, etc.)"
echo "For comprehensive local validation: ./zig/zig build ci-full"
